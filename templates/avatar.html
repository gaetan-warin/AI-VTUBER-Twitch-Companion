<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interactive Live2D Avatar</title>
    <link rel="icon" href="static/favicon.ico" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js"></script>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>

    <div class="container">
        <canvas id="live2d-canvas"></canvas>
    </div>

    <div class="controls">
        <div class="input-group">
            <textarea id="text-input" placeholder="Enter text for the avatar to speak..."></textarea>
            <button id="speakBtn">Speak</button>
        </div>
    </div>

    <script>
        const socket = io();
        const synth = window.speechSynthesis;
        let isSpeaking = false;
        let mouthTween = null;
        let modelLoaded = false;
        let loadTimeout;
        let voicesReady = false;

        function initializeLive2D() {
            console.log('Initializing Live2D...');
            
            // Attempt to initialize the Live2D widget
            try {
                L2Dwidget.init({
                    model: {
                        jsonPath: '/model/shizuku/shizuku.model.json',
                        scale: 1.2,
                    },
                    display: {
                        superSample: 2,
                        width: 400,
                        height: 800,
                        position: 'center',
                        hOffset: 0,
                        vOffset: 250,
                    },
                    mobile: {
                        show: true,
                        scale: 0.8,
                    },
                    react: {
                        opacityDefault: 1,
                        opacityOnHover: 0.8,
                    },
                    canvas: document.getElementById('live2d-canvas'),
                });

                console.log('Live2D model initialization triggered.');

                // After initialization, check if the model has loaded and is visible
                if (L2Dwidget.config && L2Dwidget.config.model && L2Dwidget.config.model.jsonPath) {
                    modelLoaded = true;
                    console.log('Live2D model loaded successfully!');
                    document.getElementById('live2d-canvas').style.opacity = 1;
                } else {
                    throw new Error('Live2D model data missing.');
                }

            } catch (error) {
                console.error('Live2D initialization failed:', error);
                handleLoadError('Live2D failed to initialize.');
            }
        }


        function handleLoadError(message) {
            console.error('Error:', message);
            alert(message);
        }

        // Speech Synthesis
        function speak(text) {
            if (!text) return;

            if (isSpeaking) {
                synth.cancel();
                isSpeaking = false;
                mouthTween?.kill();
            }

            try {
                const utterance = new SpeechSynthesisUtterance(text);

                const voices = synth.getVoices();
                let voice = voices.find((v) => v.name.includes('Female')) || voices[0];

                utterance.voice = voice;
                utterance.pitch = 1.1;
                utterance.rate = 0.95;

                utterance.onstart = () => {
                    isSpeaking = true;
                    mouthTween = gsap.to({}, {
                        duration: 0.1,
                        repeat: -1,
                        onRepeat: () => animateMouth(Math.random() * 0.5 + 0.5),
                    });
                };

                utterance.onend = () => {
                    isSpeaking = false;
                    mouthTween?.kill();
                    animateMouth(0);
                };

                synth.speak(utterance);
            } catch (error) {
                console.error('Speech synthesis error:', error);
            }
        }

        function animateMouth(value) {
            if (modelLoaded) {
                L2Dwidget.instance.setParam('ParamMouthOpenY', value);
            } else {
                console.warn('Live2D instance not found for mouth animation.');
            }
        }

        // Event Listeners
        document.getElementById('speakBtn').addEventListener('click', () => {
            const text = document.getElementById('text-input').value.trim();
            if (text) {
                socket.emit('speak', { text });
                document.getElementById('text-input').value = '';
            }
        });

        socket.on('speak_text', (data) => {
            speak(data.text);
        });

        document.addEventListener('DOMContentLoaded', () => {
            initializeLive2D();
            socket.connect();
        });

        synth.addEventListener('voiceschanged', () => {
            voicesReady = true;
        });
    </script>
</body>
</html>
